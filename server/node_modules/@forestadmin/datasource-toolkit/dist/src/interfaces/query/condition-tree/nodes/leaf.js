"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const base_1 = __importDefault(require("./base"));
const operators_1 = require("./operators");
const collection_1 = __importDefault(require("../../../../utils/collection"));
const record_1 = __importDefault(require("../../../../utils/record"));
const projection_1 = __importDefault(require("../../projection"));
const equivalence_1 = __importDefault(require("../equivalence"));
const factory_1 = __importDefault(require("../factory"));
class ConditionTreeLeaf extends base_1.default {
    get projection() {
        return new projection_1.default(this.field);
    }
    get useIntervalOperator() {
        return operators_1.intervalOperators.includes(this.operator);
    }
    constructor(field, operator, value) {
        super();
        this.field = field;
        this.operator = operator;
        this.value = value;
    }
    forEachLeaf(handler) {
        handler(this);
    }
    everyLeaf(handler) {
        return handler(this);
    }
    someLeaf(handler) {
        return handler(this);
    }
    inverse() {
        if (operators_1.allOperators.includes(`Not${this.operator}`)) {
            return this.override({ operator: `Not${this.operator}` });
        }
        if (this.operator.startsWith('Not')) {
            return this.override({ operator: this.operator.substring(3) });
        }
        switch (this.operator) {
            case 'Blank':
                return this.override({ operator: 'Present' });
            case 'Present':
                return this.override({ operator: 'Blank' });
            default:
                throw new Error(`Operator '${this.operator}' cannot be inverted.`);
        }
    }
    replaceLeafs(handler, bind) {
        const result = handler.call(bind, this);
        return result instanceof base_1.default ? result : factory_1.default.fromPlainObject(result);
    }
    async replaceLeafsAsync(handler, bind) {
        const result = await handler.call(bind, this);
        return result instanceof base_1.default ? result : factory_1.default.fromPlainObject(result);
    }
    match(record, collection, timezone) {
        const fieldValue = record_1.default.getFieldValue(record, this.field);
        const { columnType } = collection_1.default.getFieldSchema(collection, this.field);
        switch (this.operator) {
            case 'Equal':
                return fieldValue == this.value; // eslint-disable-line eqeqeq
            case 'LessThan':
                return fieldValue < this.value;
            case 'GreaterThan':
                return fieldValue > this.value;
            case 'Like':
                return this.like(fieldValue, this.value, true);
            case 'ILike':
                return this.like(fieldValue, this.value, false);
            case 'LongerThan':
                return typeof fieldValue === 'string' ? fieldValue.length > this.value : false;
            case 'ShorterThan':
                return typeof fieldValue === 'string' ? fieldValue.length < this.value : false;
            case 'IncludesAll':
                return !!this.value?.every(v => fieldValue?.includes(v));
            case 'NotEqual':
            case 'NotContains':
                return !this.inverse().match(record, collection, timezone);
            default:
                return equivalence_1.default.getEquivalentTree(this, new Set(operators_1.uniqueOperators), columnType, timezone).match(record, collection, timezone);
        }
    }
    override(params) {
        return factory_1.default.fromPlainObject({ ...this, ...params });
    }
    unnest() {
        return super.unnest();
    }
    /** @see https://stackoverflow.com/a/18418386/1897495 */
    like(value, pattern, caseSensitive) {
        if (!value)
            return false;
        let regexp = pattern;
        // eslint-disable-next-line no-useless-escape
        regexp = regexp.replace(/([\.\\\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:\-])/g, '\\$1');
        regexp = regexp.replace(/%/g, '.*').replace(/_/g, '.');
        return RegExp(`^${regexp}$`, caseSensitive ? 'g' : 'gi').test(value);
    }
}
exports.default = ConditionTreeLeaf;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGVhZi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9pbnRlcmZhY2VzL3F1ZXJ5L2NvbmRpdGlvbi10cmVlL25vZGVzL2xlYWYudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxrREFBMkQ7QUFDM0QsMkNBQXlGO0FBQ3pGLDhFQUEyRDtBQUMzRCxzRUFBbUQ7QUFJbkQsa0VBQTBDO0FBQzFDLGlFQUFxRDtBQUNyRCx5REFBOEM7QUFVOUMsTUFBcUIsaUJBQWtCLFNBQVEsY0FBYTtJQUsxRCxJQUFJLFVBQVU7UUFDWixPQUFPLElBQUksb0JBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELElBQUksbUJBQW1CO1FBQ3JCLE9BQU8sNkJBQWlCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUE4QyxDQUFDLENBQUM7SUFDekYsQ0FBQztJQUVELFlBQVksS0FBYSxFQUFFLFFBQWtCLEVBQUUsS0FBZTtRQUM1RCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxXQUFXLENBQUMsT0FBcUI7UUFDL0IsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hCLENBQUM7SUFFRCxTQUFTLENBQUMsT0FBbUI7UUFDM0IsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVELFFBQVEsQ0FBQyxPQUFtQjtRQUMxQixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksd0JBQVksQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFjLENBQUMsRUFBRTtZQUM1RCxPQUFP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