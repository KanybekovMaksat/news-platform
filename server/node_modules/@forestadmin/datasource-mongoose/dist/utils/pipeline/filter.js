"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const datasource_toolkit_1 = require("@forestadmin/datasource-toolkit");
const luxon_1 = require("luxon");
const mongoose_1 = require("mongoose");
const schema_1 = __importDefault(require("../../mongoose/schema"));
const version_manager_1 = __importDefault(require("../version-manager"));
const STRING_OPERATORS = ['Like', 'ILike', 'NotContains', 'LongerThan', 'ShorterThan'];
/** Transform a forest admin filter into mongo pipeline */
class FilterGenerator {
    static filter(model, stack, filter) {
        const fields = new Set();
        const tree = filter?.conditionTree;
        const match = this.computeMatch(model, stack, tree, fields);
        const sort = this.computeSort(filter?.sort);
        const pipeline = [];
        if (fields.size)
            pipeline.push(this.computeFields(fields));
        if (match)
            pipeline.push({ $match: match });
        if (sort)
            pipeline.push({ $sort: sort });
        if (filter?.page?.skip !== undefined)
            pipeline.push({ $skip: filter.page.skip });
        if (filter?.page?.limit !== undefined)
            pipeline.push({ $limit: filter.page.limit });
        return pipeline;
    }
    static computeMatch(model, stack, tree, fields) {
        const schema = schema_1.default.fromModel(model).applyStack(stack, true);
        if (tree instanceof datasource_toolkit_1.ConditionTreeBranch) {
            return {
                [`$${tree.aggregator.toLowerCase()}`]: tree.conditions.map(condition => this.computeMatch(model, stack, condition, fields)),
            };
        }
        if (tree instanceof datasource_toolkit_1.ConditionTreeLeaf) {
            const value = this.formatAndCastLeafValue(schema, tree, fields);
            const condition = this.buildMatchCondition(tree.operator, value);
            return { [this.formatNestedFieldPath(tree.field)]: condition };
        }
        return null;
    }
    static formatAndCastLeafValue(schema, leaf, fields) {
        // @fixme not a big fan of modifying the condition tree here.
        // those objects should be frozen, as the modification will show if the condition tree
        // is used after the request (for instance for "after hooks").
        let { value } = leaf;
        leaf.field = this.formatNestedFieldPath(leaf.field);
        const [isArray, instance] = this.getFieldMetadata(schema, leaf.field);
        // @fixme I'm really not sure that this can work in all cases.
        // It assumes that the type of the value is the same than the type of the column
        // which is not the case for many operators.
        if (isArray) {
            if (instance === 'Date' &&
                Array.isArray(value) &&
                value.every(v => luxon_1.DateTime.fromISO(v).isValid)) {
                value = value.map(v => new Date(v));
            }
            else if (instance === version_manager_1.default.ObjectIdTypeName &&
                Array.isArray(value) &&
                value.every(v => (0, mongoose_1.isValidObjectId)(v))) {
                value = value.map(id => new mongoose_1.Types.ObjectId(id));
            }
        }
        else if (instance === version_manager_1.default.ObjectIdTypeName) {
            if (STRING_OPERATORS.includes(leaf.operator)) {
                fields.add(leaf.field);
                leaf.field = this.formatStringFieldName(leaf.field);
            }
            else if (Array.isArray(value) && value.every(v => (0, mongoose_1.isValidObjectId)(v))) {
                value = value.map(id => new mongoose_1.Types.ObjectId(id));
            }
            else if ((0, mongoose_1.isValidObjectId)(value)) {
                value = new mongoose_1.Types.ObjectId(value);
            }
        }
        else if (instance === 'Date') {
            value = new Date(value);
        }
        return value;
    }
    static buildMatchCondition(operator, formattedLeafValue) {
        switch (operator) {
            case 'GreaterThan':
                return { $gt: formattedLeafValue };
            case 'LessThan':
                return { $lt: formattedLeafValue };
            case 'Equal':
                return { $eq: formattedLeafValue };
            case 'NotEqual':
                return { $ne: formattedLeafValue };
            case 'In':
                return { $in: formattedLeafValue };
            case 'IncludesAll':
                return { $all: formattedLeafValue };
            case 'NotContains':
                return { $not: new RegExp(`.*${formattedLeafValue}.*`) };
            case 'Like':
                return this.like(formattedLeafValue, true);
            case 'ILike':
                return this.like(formattedLeafValue, false);
            case 'Present':
                return { $exists: true, $ne: null };
            default:
                throw new Error(`Unsupported '${operator}' operator`);
        }
    }
    /** @see https://stackoverflow.com/a/18418386/1897495 */
    static like(pattern, caseSensitive) {
        let regexp = pattern;
        // eslint-disable-next-line no-useless-escape
        regexp = regexp.replace(/([\.\\\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:\-])/g, '\\$1');
        regexp = regexp.replace(/%/g, '.*').replace(/_/g, '.');
        return RegExp(`^${regexp}$`, caseSensitive ? 'g' : 'gi');
    }
    static computeSort(sorts) {
        if (!sorts || sorts.length === 0)
            return null;
        const result = {};
        for (const { field, ascending } of sorts) {
            const formattedField = this.formatNestedFieldPath(field);
            result[formattedField] = ascending ? 1 : -1;
        }
        return result;
    }
    static computeFields(fields) {
        return Array.from(fields).reduce((computed, field) => {
            const stringField = this.formatStringFieldName(field);
            computed.$addFields[stringField] = { $toString: `$${field}` };
            return computed;
        }, { $addFields: {} });
    }
    static formatNestedFieldPath(field) {
        return field.replace(/:/g, '.');
    }
    static formatStringFieldName(field) {
        const parts = field.split('.');
        parts.push(`string_${parts.pop()}`);
        return parts.join('.');
    }
    static getFieldMetadata(schema, field) {
        // nested _ids are strings
        let isArray;
        let instance;
        try {
            // This may crash when we query virtual one to one relationships, because their virtual
            // fields are not in the schema (This is documented in MongooseSchema)
            const subSchema = schema.getSubSchema(field);
            isArray = subSchema.isArray;
            instance = subSchema.schemaType.instance;
        }
        catch {
            isArray = false;
            instance = 'String';
        }
        return [isArray, instance];
    }
}
exports.default = FilterGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3V0aWxzL3BpcGVsaW5lL2ZpbHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLHdFQU15QztBQUN6QyxpQ0FBaUM7QUFDakMsdUNBQXdFO0FBRXhFLG1FQUFtRDtBQUVuRCx5RUFBZ0Q7QUFFaEQsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztBQUV2RiwwREFBMEQ7QUFDMUQsTUFBcUIsZUFBZTtJQUNsQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQXFCLEVBQUUsS0FBWSxFQUFFLE1BQXVCO1FBQ3hFLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDakMsTUFBTSxJQUFJLEdBQUcsTUFBTSxFQUFFLGFBQWEsQ0FBQztRQUNuQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzVELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRTVDLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLE1BQU0sQ0FBQyxJQUFJO1lBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDM0QsSUFBSSxLQUFLO1lBQUUsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzVDLElBQUksSUFBSTtZQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUN6QyxJQUFJLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFB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