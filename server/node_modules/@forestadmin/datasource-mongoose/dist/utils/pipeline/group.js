"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/** Transform a forest admin aggregation into mongo pipeline */
class GroupGenerator {
    static group(aggregation) {
        return [
            {
                $group: {
                    _id: this.computeGroups(aggregation.groups),
                    value: this.computeValue(aggregation),
                },
            },
            {
                $project: {
                    _id: 0,
                    value: '$value',
                    group: this.computeGroupsProjection(aggregation.groups),
                },
            },
        ];
    }
    /** Compute aggregation value */
    static computeValue(aggregation) {
        // Handle count(*) case
        if (!aggregation.field)
            return { $sum: 1 };
        // General case
        const field = `$${aggregation.field.replace(/:/g, '.')}`;
        return aggregation.operation === 'Count'
            ? { $sum: { $cond: [{ $ne: [field, null] }, 1, 0] } }
            : {
                [this.AGGREGATION_OPERATION[aggregation.operation]]: field,
            };
    }
    /** Compute _id field for the $group pipeline stage */
    static computeGroups(groups) {
        return (groups ?? []).reduce((memo, group) => {
            let field = `$${group.field.replace(/:/g, '.')}`;
            if (group.operation) {
                if (group.operation === 'Week') {
                    const date = { $dateTrunc: { date: field, startOfWeek: 'Monday', unit: 'week' } };
                    field = { $dateToString: { format: this.GROUP_OPERATION[group.operation], date } };
                }
                else {
                    field = { $dateToString: { format: this.GROUP_OPERATION[group.operation], date: field } };
                }
            }
            return { ...(memo ?? {}), [group.field]: field };
        }, null);
    }
    /** Move fields in _id to the root of the document */
    static computeGroupsProjection(groups) {
        return groups?.length
            ? groups.reduce((memo, group) => ({ ...memo, [group.field]: `$_id.${group.field}` }), {})
            : { $literal: {} };
    }
}
exports.default = GroupGenerator;
GroupGenerator.AGGREGATION_OPERATION = {
    Sum: '$sum',
    Avg: '$avg',
    Count: '$sum',
    Max: '$max',
    Min: '$min',
};
GroupGenerator.GROUP_OPERATION = {
    Year: '%Y-01-01',
    Month: '%Y-%m-01',
    Day: '%Y-%m-%d',
    Week: '%Y-%m-%d',
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvdXRpbHMvcGlwZWxpbmUvZ3JvdXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFHQSwrREFBK0Q7QUFDL0QsTUFBcUIsY0FBYztJQWdCakMsTUFBTSxDQUFDLEtBQUssQ0FBQyxXQUF3QjtRQUNuQyxPQUFPO1lBQ0w7Z0JBQ0UsTUFBTSxFQUFFO29CQUNOLEdBQUcsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7b0JBQzNDLEtBQUssRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztpQkFDdEM7YUFDRjtZQUNEO2dCQUNFLFFBQVEsRUFBRTtvQkFDUixHQUFHLEVBQUUsQ0FBQztvQkFDTixLQUFLLEVBQUUsUUFBUTtvQkFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7aUJBQ3hEO2FBQ0Y7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELGdDQUFnQztJQUN4QixNQUFNLENBQUMsWUFBWSxDQUFDLFdBQXdCO1FBQ2xELHVCQUF1QjtRQUN2QixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUs7WUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBRTNDLGVBQWU7UUFDZixNQUFNLEtBQUssR0FBRyxJQUFJLFdBQVcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBRXpELE9BQU8sV0FBVyxDQUFDLFNBQVMsS0FBSyxPQUFPO1lBQ3RDLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDckQsQ0FBQyxDQUFFO2dCQUNDLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEtBQUs7YUFDeEIsQ0FBQztJQUMzQyxDQUFDO0lBRUQsc0RBQXNEO0lBQzlDLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBNkI7UUFDeEQsT0FBTyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDM0MsSUFBSSxLQUFLLEdBQVksSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUUxRCxJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUU7Z0JBQ25CLElBQUksS0FBSyxDQUFDLFNBQVMsS0FBSyxNQUFNLEVBQUU7b0JBQzlCLE1BQU0sSUFBSSxHQUFHLEVBQUUsVUFBVSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDO29CQUNsRixLQUFLLEdBQUcsRUFBRSxhQUFhLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQztpQkFDcEY7cUJBQU07b0JBQ0wsS0FBSyxHQUFHLEVBQUUsYUFBYSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDO2lCQUMzRjthQUNGO1lBRUQsT0FBTyxFQUFFLEdBQUcsQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDbkQsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVELHFEQUFxRDtJQUM3QyxNQUFNLENBQUMsdUJBQXVCLENBQUMsTUFBNkI7UUFDbEUsT0FBTyxNQUFNLEVBQUUsTUFBTTtZQUNuQixDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxRQUFRLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3pGLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQztJQUN2QixDQUFDOztBQXhFSCxpQ0F5RUM7QUF4RWdCLG9DQUFxQixHQUF5QztJQUMzRSxHQUFHLEVBQUUsTUFBTTtJQUNYLEdBQUcsRUFBRSxNQUFNO0lBQ1gsS0FBSyxFQUFFLE1BQU07SUFDYixHQUFHLEVBQUUsTUFBTTtJQUNYLEdBQUcsRUFBRSxNQUFNO0NBQ1osQ0FBQztBQUVhLDhCQUFlLEdBQWtDO0lBQzlELElBQUksRUFBRSxVQUFVO0lBQ2hCLEtBQUssRUFBRSxVQUFVO0lBQ2pCLEdBQUcsRUFBRSxVQUFVO0lBQ2YsSUFBSSxFQUFFLFVBQVU7Q0FDakIsQ0FBQyJ9