"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const datasource_toolkit_1 = require("@forestadmin/datasource-toolkit");
const object_hash_1 = __importDefault(require("object-hash"));
const approval_not_allowed_error_1 = __importDefault(require("./errors/approval-not-allowed-error"));
const custom_action_requires_approval_error_1 = __importDefault(require("./errors/custom-action-requires-approval-error"));
const custom_action_trigger_forbidden_error_1 = __importDefault(require("./errors/custom-action-trigger-forbidden-error"));
const invalid_action_condition_error_1 = __importDefault(require("./errors/invalid-action-condition-error"));
const condition_tree_parser_1 = __importDefault(require("../../../utils/condition-tree-parser"));
class ActionAuthorizationService {
    constructor(forestAdminClient) {
        this.forestAdminClient = forestAdminClient;
    }
    async assertCanTriggerCustomAction({ customActionName, collection, filterForCaller, filterForAllCaller, caller, }) {
        const canTrigger = await this.canTriggerCustomAction(caller, customActionName, collection, filterForCaller);
        if (!canTrigger) {
            throw new custom_action_trigger_forbidden_error_1.default();
        }
        const triggerRequiresApproval = await this.doesTriggerCustomActionRequiresApproval(caller, customActionName, collection, filterForCaller);
        if (triggerRequiresApproval) {
            const roleIdsAllowedToApprove = await this.getRoleIdsAllowedToApprove(caller, customActionName, collection, filterForAllCaller);
            throw new custom_action_requires_approval_error_1.default(roleIdsAllowedToApprove);
        }
    }
    async assertCanApproveCustomAction({ customActionName, requesterId, collection, filterForCaller, filterForAllCaller, caller, }) {
        const canApprove = await this.canApproveCustomAction(caller, customActionName, collection, filterForCaller, requesterId);
        if (!canApprove) {
            const roleIdsAllowedToApprove = await this.getRoleIdsAllowedToApprove(caller, customActionName, collection, filterForAllCaller);
            throw new approval_not_allowed_error_1.default(roleIdsAllowedToApprove);
        }
    }
    async assertCanRequestCustomActionParameters({ userId, customActionName, collectionName, }) {
        const canRequest = await this.forestAdminClient.permissionService.canRequestCustomActionParameters({
            userId,
            customActionName,
            collectionName,
        });
        if (!canRequest) {
            throw new datasource_toolkit_1.ForbiddenError();
        }
    }
    async canTriggerCustomAction(caller, customActionName, collection, filterForCaller) {
        const canTrigger = await this.forestAdminClient.permissionService.canTriggerCustomAction({
            userId: caller.id,
            customActionName,
            collectionName: collection.name,
        });
        if (!canTrigger) {
            return false;
        }
        const conditionalTriggerRawCondition = await this.forestAdminClient.permissionService.getConditionalTriggerCondition({
            userId: caller.id,
            customActionName,
            collectionName: collection.name,
        });
        return ActionAuthorizationService.canPerformConditionalCustomAction(caller, collection, filterForCaller, conditionalTriggerRawCondition);
    }
    async doesTriggerCustomActionRequiresApproval(caller, customActionName, collection, filterForCaller) {
        const doesTriggerRequiresApproval = await this.forestAdminClient.permissionService.doesTriggerCustomActionRequiresApproval({
            userId: caller.id,
            customActionName,
            collectionName: collection.name,
        });
        if (!doesTriggerRequiresApproval) {
            return false;
        }
        const conditionalRequiresApprovalRawCondition = await this.forestAdminClient.permissionService.getConditionalRequiresApprovalCondition({
            userId: caller.id,
            customActionName,
            collectionName: collection.name,
        });
        if (conditionalRequiresApprovalRawCondition) {
            const matchingRecordsCount = await ActionAuthorizationService.aggregateCountConditionIntersection(caller, collection, filterForCaller, conditionalRequiresApprovalRawCondition);
            // No records match the condition, trigger does not require approval
            if (matchingRecordsCount === 0) {
                return false;
            }
        }
        return true;
    }
    async canApproveCustomAction(caller, customActionName, collection, filterForCaller, requesterId) {
        const canApprove = await this.forestAdminClient.permissionService.canApproveCustomAction({
            userId: caller.id,
            requesterId,
            customActionName,
            collectionName: collection.name,
        });
        if (!canApprove) {
            return false;
        }
        const conditionalApproveRawCondition = await this.forestAdminClient.permissionService.getConditionalApproveCondition({
            userId: caller.id,
            customActionName,
            collectionName: collection.name,
        });
        return ActionAuthorizationService.canPerformConditionalCustomAction(caller, collection, filterForCaller, conditionalApproveRawCondition);
    }
    async getRoleIdsAllowedToApprove(caller, customActionName, collection, filterForAllCaller) {
        const actionConditionsByRoleId = await this.forestAdminClient.permissionService.getConditionalApproveConditions({
            customActionName,
            collectionName: collection.name,
        });
        const roleIdsAllowedToApproveWithoutConditions = await this.forestAdminClient.permissionService.getRoleIdsAllowedToApproveWithoutConditions({
            customActionName,
            collectionName: collection.name,
        });
        // Optimization - We groupBy conditions to only make the aggregate count once when possible
        const rolesIdsGroupByConditions = ActionAuthorizationService.transformToRolesIdsGroupByConditions(actionConditionsByRoleId);
        if (!rolesIdsGroupByConditions.length) {
            return roleIdsAllowedToApproveWithoutConditions;
        }
        const [requestRecordsCount, ...conditionRecordsCounts] = await Promise.all([
            ActionAuthorizationService.aggregateCountConditionIntersection(caller, collection, filterForAllCaller),
            ...rolesIdsGroupByConditions.map(({ condition }) => ActionAuthorizationService.aggregateCountConditionIntersection(caller, collection, filterForAllCaller, condition)),
        ]);
        return rolesIdsGroupByConditions.reduce((roleIdsAllowedToApprove, { roleIds }, currentIndex) => {
            if (requestRecordsCount === conditionRecordsCounts[currentIndex]) {
                roleIdsAllowedToApprove.push(...roleIds);
            }
            return roleIdsAllowedToApprove;
        }, 
        // Roles  with userApprovalEnabled excluding the one with conditions
        // are allowed to approve by default
        roleIdsAllowedToApproveWithoutConditions);
    }
    static async canPerformConditionalCustomAction(caller, collection, requestFilter, condition) {
        if (condition) {
            const [requestRecordsCount, matchingRecordsCount] = await Promise.all([
                ActionAuthorizationService.aggregateCountConditionIntersection(caller, collection, requestFilter),
                ActionAuthorizationService.aggregateCountConditionIntersection(caller, collection, requestFilter, condition),
            ]);
            // If all records condition the condition everything is ok
            // Otherwise when some records don't match the condition then the user
            // is not allow to perform the conditional action
            return matchingRecordsCount === requestRecordsCount;
        }
        return true;
    }
    static async aggregateCountConditionIntersection(caller, collection, requestFilter, condition) {
        try {
            // Override request filter with condition if any
            const conditionalFilter = requestFilter.override({
                conditionTree: condition
                    ? datasource_toolkit_1.ConditionTreeFactory.intersect(condition_tree_parser_1.default.fromPlainObject(collection, condition), requestFilter.conditionTree)
                    : requestFilter.conditionTree,
            });
            const rows = await collection.aggregate(caller, conditionalFilter, new datasource_toolkit_1.Aggregation({
                operation: 'Count',
            }));
            return rows?.[0]?.value ?? 0;
        }
        catch (error) {
            throw new invalid_action_condition_error_1.default();
        }
    }
    /**
     * Given a map it groups keys based on their hash values
     */
    static transformToRolesIdsGroupByConditions(actionConditionsByRoleId) {
        const rolesIdsGroupByConditions = Array.from(actionConditionsByRoleId, ([roleId, condition]) => {
            return {
                roleId,
                condition,
                conditionHash: (0, object_hash_1.default)(condition, { respectType: false }),
            };
        }).reduce((acc, current) => {
            const { roleId, condition, conditionHash } = current;
            if (acc.has(conditionHash)) {
                acc.get(conditionHash).roleIds.push(roleId);
            }
            else {
                acc.set(conditionHash, { roleIds: [roleId], condition });
            }
            return acc;
        }, new Map());
        return Array.from(rolesIdsGroupByConditions.values());
    }
}
exports.default = ActionAuthorizationService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aW9uLWF1dGhvcml6YXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcm91dGVzL21vZGlmaWNhdGlvbi9hY3Rpb24vYWN0aW9uLWF1dGhvcml6YXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSx3RUFPeUM7QUFFekMsOERBQXFDO0FBRXJDLHFHQUEwRTtBQUMxRSwySEFBK0Y7QUFDL0YsMkhBQStGO0FBQy9GLDZHQUFrRjtBQUNsRixpR0FBdUU7QUFVdkUsTUFBcUIsMEJBQTBCO0lBQzdDLFlBQTZCLGlCQUFvQztRQUFwQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO0lBQUcsQ0FBQztJQUU5RCxLQUFLLENBQUMsNEJBQTRCLENBQUMsRUFDeEMsZ0JBQWdCLEVBQ2hCLFVBQVUsRUFDVixlQUFlLEVBQ2Ysa0JBQWtCLEVBQ2xCLE1BQU0sR0FDdUI7UUFDN0IsTUFBTSxVQUFVLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQ2xELE1BQU0sRUFDTixnQkFBZ0IsRUFDaEIsVUFBVSxFQUNWLGVBQWUsQ0FDaEIsQ0FBQztRQUVGLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixNQUFNLElBQUksK0NBQWlDLEVBQUUsQ0FBQztTQUMvQztRQUVELE1BQU0sdUJBQXVCLEdBQUcsTUFBTSxJQUFJLENBQUMsdUNBQXVDLENBQ2hGLE1BQU0sRUFDTixnQkFBZ0IsRUFDaEIsVUFBVSxFQUNWLGVBQWUsQ0FDaEIsQ0FBQztRQUVGLElBQUksdUJBQXVCLEVBQUU7WUFDM0IsTUFBTSx1QkFBdUIsR0FBRyxNQUFNLElBQUksQ0FBQywwQkFBMEIsQ0FDbkUsTUFBTSxFQUNOLGdCQUFnQixFQUNoQixVQUFVLEVBQ1Ysa0JBQWtCLENBQ25CLENBQUM7WUFFRixNQUFNLElBQUksK0NBQWlDLENBQUMsdUJBQXVCLENBQUMsQ0FBQztTQUN0RTtJQUNILENBQUM7SUFFTSxLQUFLLENBQUMsNEJBQTRCLENB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