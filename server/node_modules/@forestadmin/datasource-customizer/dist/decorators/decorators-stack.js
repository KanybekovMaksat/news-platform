"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const collection_1 = __importDefault(require("./actions/collection"));
const datasource_1 = __importDefault(require("./chart/datasource"));
const collection_2 = __importDefault(require("./computed/collection"));
const datasource_decorator_1 = __importDefault(require("./datasource-decorator"));
const collection_3 = __importDefault(require("./empty/collection"));
const collection_4 = __importDefault(require("./hook/collection"));
const collection_5 = __importDefault(require("./operators-emulate/collection"));
const collection_6 = __importDefault(require("./operators-equivalence/collection"));
const collection_7 = __importDefault(require("./publication-field/collection"));
const collection_8 = __importDefault(require("./relation/collection"));
const collection_9 = __importDefault(require("./rename-field/collection"));
const collection_10 = __importDefault(require("./schema/collection"));
const collection_11 = __importDefault(require("./search/collection"));
const collection_12 = __importDefault(require("./segment/collection"));
const collection_13 = __importDefault(require("./sort-emulate/collection"));
const collection_14 = __importDefault(require("./validation/collection"));
const datasource_2 = __importDefault(require("./write/datasource"));
class DecoratorsStack {
    constructor(dataSource) {
        this.customizations = [];
        let last = dataSource;
        /* eslint-disable no-multi-assign */
        // Step 0: Do not query datasource when we know the result with yield an empty set.
        last = new datasource_decorator_1.default(last, collection_3.default);
        last = new datasource_decorator_1.default(last, collection_6.default);
        // Step 1: Computed-Relation-Computed sandwich (needed because some emulated relations depend
        // on computed fields, and some computed fields depend on relation...)
        // Note that replacement goes before emulation, as replacements may use emulated operators.
        last = this.earlyComputed = new datasource_decorator_1.default(last, collection_2.default);
        last = this.earlyOpEmulate = new datasource_decorator_1.default(last, collection_5.default);
        last = new datasource_decorator_1.default(last, collection_6.default);
        last = this.relation = new datasource_decorator_1.default(last, collection_8.default);
        last = this.lateComputed = new datasource_decorator_1.default(last, collection_2.default);
        last = this.lateOpEmulate = new datasource_decorator_1.default(last, collection_5.default);
        last = new datasource_decorator_1.default(last, collection_6.default);
        // Step 2: Those need access to all fields. They can be loaded in any order.
        last = this.search = new datasource_decorator_1.default(last, collection_11.default);
        last = this.segment = new datasource_decorator_1.default(last, collection_12.default);
        last = this.sortEmulate = new datasource_decorator_1.default(last, collection_13.default);
        // Step 3: Access to all fields AND emulated capabilities
        last = this.chart = new datasource_1.default(last);
        last = this.action = new datasource_decorator_1.default(last, collection_1.default);
        last = this.schema = new datasource_decorator_1.default(last, collection_10.default);
        last = this.write = new datasource_2.default(last);
        last = this.hook = new datasource_decorator_1.default(last, collection_4.default);
        last = this.validation = new datasource_decorator_1.default(last, collection_14.default);
        // Step 4: Renaming must be either the very first or very last so that naming in customer code
        // is consistent.
        last = this.publication = new datasource_decorator_1.default(last, collection_7.default);
        last = this.renameField = new datasource_decorator_1.default(last, collection_9.default);
        /* eslint-enable no-multi-assign */
        this.dataSource = last;
    }
    queueCustomization(customization) {
        this.customizations.push(customization);
    }
    /**
     * Apply all customizations
     * Plugins may queue new customizations, or call other plugins which will queue customizations.
     *
     * This method will be called recursively and clears the queue at each recursion to ensure
     * that all customizations are applied in the right order.
     */
    async applyQueuedCustomizations(logger) {
        const queuedCustomizations = this.customizations.slice();
        this.customizations.length = 0;
        while (queuedCustomizations.length) {
            await queuedCustomizations.shift()(logger); // eslint-disable-line no-await-in-loop
            await this.applyQueuedCustomizations(logger); // eslint-disable-line no-await-in-loop
        }
    }
}
exports.default = DecoratorsStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVjb3JhdG9ycy1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kZWNvcmF0b3JzL2RlY29yYXRvcnMtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQSxzRUFBNkQ7QUFDN0Qsb0VBQTBEO0FBQzFELHVFQUFnRTtBQUNoRSxrRkFBeUQ7QUFDekQsb0VBQTBEO0FBQzFELG1FQUF3RDtBQUN4RCxnRkFBaUY7QUFDakYsb0ZBQXlGO0FBQ3pGLGdGQUFpRjtBQUNqRix1RUFBZ0U7QUFDaEUsMkVBQXVFO0FBQ3ZFLHNFQUE0RDtBQUM1RCxzRUFBNEQ7QUFDNUQsdUVBQThEO0FBQzlELDRFQUF1RTtBQUN2RSwwRUFBb0U7QUFDcEUsb0VBQTBEO0FBRTFELE1BQXFCLGVBQWU7SUFxQmxDLFlBQVksVUFBc0I7UUFGMUIsbUJBQWMsR0FBNkMsRUFBRSxDQUFDO1FBR3BFLElBQUksSUFBSSxHQUFlLFVBQVUsQ0FBQztRQUVsQyxvQ0FBb0M7UUFDcEMsbUZBQW1GO1FBQ25GLElBQUksR0FBRyxJQUFJLDhCQUFtQixDQUFDLElBQUksRUFBRSxvQkFBd0IsQ0FBQyxDQUFDO1FBQy9ELElBQUksR0FBRyxJQUFJLDhCQUFtQixDQUFDLElBQUksRUFBRSxvQkFBdUMsQ0FBQyxDQUFDO1FBRTlFLDZGQUE2RjtRQUM3RixzRUFBc0U7UUFDdEUsMkZBQTJGO1FBQzNGLElBQUksR0FBRyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksOEJBQW1CLENBQUMsSUFBSSxFQUFFLG9CQUEyQixDQUFDLENBQUM7UUFDdkYsSUFBSSxHQUFHLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSw4QkFBbUIsQ0FBQyxJQUFJLEVBQUUsb0JBQW1DLENBQUMsQ0FBQztRQUNoRyxJQUFJLEdBQUcsSUFBSSw4QkFBbUIsQ0FBQyxJQUFJLEVBQUUsb0JBQXVDLENBQUMsQ0FBQztRQUM5RSxJQUFJLEdBQUcsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJ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