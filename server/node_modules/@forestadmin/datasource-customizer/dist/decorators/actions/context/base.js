"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
/* eslint-disable max-classes-per-file */
const datasource_toolkit_1 = require("@forestadmin/datasource-toolkit");
const collection_context_1 = __importDefault(require("../../../context/collection-context"));
class Deferred {
    constructor() {
        this.promise = new Promise((resolve, reject) => {
            this.reject = reject;
            this.resolve = resolve;
        });
    }
}
class ActionContext extends collection_context_1.default {
    constructor(collection, caller, formValue, filter, used) {
        super(collection, caller);
        this.formValues = formValue;
        this.filter = filter;
        this.reset();
        // Spy on which formValues are accessed to set-up change hooks
        if (used) {
            this.formValues = new Proxy(this.formValues, {
                get: (target, prop, receiver) => {
                    if (typeof prop === 'string')
                        used.add(prop);
                    return Reflect.get(target, prop, receiver);
                },
                set: () => {
                    throw new Error('formValues is readonly');
                },
            });
        }
    }
    /**
     * Get all the records selected by an action
     * @param fields An array of fields needed in the response
     * @example
     * .getRecords(['id', 'isActive', 'name']);
     */
    async getRecords(fields) {
        // This function just queues the request into this.queries, so that we can merge all calls
        // to getRecords() into a single one.
        // The call to setTimeout which resolve the promises will trigger only once all handlers in
        // the customer's form have been called as Promises are queued before calls to setTimeout
        // in Node.js event loop
        // @see https://dev.to/khaosdoctor/node-js-under-the-hood-3-deep-dive-into-the-event-loop-135d\
        //   #microtasks-and-macrotasks
        //   Ordering of micro/macro tasks in Node.js event loop
        //
        // @see https://github.com/graphql/dataloader
        //   A library from facebook from which this pattern is inspired.
        datasource_toolkit_1.ProjectionValidator.validate(this.realCollection, fields);
        const deferred = new Deferred();
        const projection = new datasource_toolkit_1.Projection(...fields);
        if (this.queries.length === 0)
            setTimeout(() => this.runQuery());
        this.queries.push({ projection, deferred });
        this.projection = this.projection.union(projection);
        return deferred.promise;
    }
    /**
     * Get all the records ids selected by an action
     */
    async getRecordIds() {
        const compositeIds = await this.getCompositeRecordIds();
        return compositeIds.map(id => id[0]);
    }
    /**
     * Get all the records ids (when the collection uses composite keys)
     */
    async getCompositeRecordIds() {
        const projection = new datasource_toolkit_1.Projection().withPks(this.realCollection);
        const records = await this.getRecords(projection);
        return records.map(r => datasource_toolkit_1.RecordUtils.getPrimaryKey(this.realCollection.schema, r));
    }
    async runQuery() {
        const { queries, projection } = this;
        this.reset();
        try {
            // Run a single query which contains all fields / relations which were requested by
            // the different calls made to getRecords
            const records = await this.collection.list(this.filter, projection);
            // Resolve each on of the promises only with the requested fields.
            for (const query of queries)
                query.deferred.resolve(query.projection.apply(records));
        }
        catch (e) {
            // Rejecting each promises at next tick
            // This ensures that we don't let any promise hanging forever if the customer throws in
            // the rejection handler.
            for (const query of queries) {
                process.nextTick(() => query.deferred.reject(e));
            }
        }
    }
    reset() {
        this.queries = [];
        this.projection = new datasource_toolkit_1.Projection();
    }
}
exports.default = ActionContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kZWNvcmF0b3JzL2FjdGlvbnMvY29udGV4dC9iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUNBQXlDO0FBQ3pDLHdFQVF5QztBQUV6Qyw2RkFBaUY7QUFHakYsTUFBTSxRQUFRO0lBS1o7UUFDRSxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzdDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1lBQ3JCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBRUQsTUFBcUIsYUFHbkIsU0FBUSw0QkFBb0M7SUFPNUMsWUFDRSxVQUFzQixFQUN0QixNQUFjLEVBQ2QsU0FBcUIsRUFDckIsTUFBcUIsRUFDckIsSUFBa0I7UUFFbEIsS0FBSyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMxQixJQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztRQUM1QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFYiw4REFBOEQ7UUFDOUQsSUFBSSxJQUFJLEVBQUU7WUFDUixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQzNDLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEVBQUU7b0JBQzlCLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUTt3QkFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUU3QyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FB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