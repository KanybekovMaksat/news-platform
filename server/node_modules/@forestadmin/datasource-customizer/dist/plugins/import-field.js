"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const datasource_toolkit_1 = require("@forestadmin/datasource-toolkit");
async function importField(dataSourceCustomizer, collectionCustomizer, options) {
    const name = options.name;
    const { schema } = options.path.split(':').reduce((memo, field) => {
        const collection = dataSourceCustomizer.getCollection(memo.collection);
        const fieldSchema = collection.schema.fields[field];
        if (fieldSchema === undefined) {
            throw new Error(`Field ${field} not found in collection ${collection.name}`);
        }
        if (fieldSchema.type === 'Column')
            return { schema: fieldSchema };
        if (fieldSchema.type === 'ManyToOne' || fieldSchema.type === 'OneToOne')
            return { collection: fieldSchema.foreignCollection };
        throw new Error('Invalid options.path');
    }, { collection: collectionCustomizer.name });
    collectionCustomizer.addField(name, {
        columnType: schema.columnType,
        defaultValue: schema.defaultValue,
        dependencies: [options.path],
        getValues: records => records.map(r => datasource_toolkit_1.RecordUtils.getFieldValue(r, options.path)),
        enumValues: schema.enumValues,
    });
    if (!schema.isReadOnly && !options.readonly) {
        collectionCustomizer.replaceFieldWriting(name, value => {
            const path = options.path.split(':');
            const writingPath = {};
            path.reduce((nestedPath, currentPath, index) => {
                nestedPath[currentPath] = index === path.length - 1 ? value : {};
                return nestedPath[currentPath];
            }, writingPath);
            return writingPath;
        });
    }
    if (schema.isReadOnly && options.readonly === false) {
        throw new Error(`Readonly option should not be false because the field "${options.path}" is not writable`);
    }
    for (const operator of schema.filterOperators) {
        const handler = value => ({ field: options.path, operator, value });
        collectionCustomizer.replaceFieldOperator(name, operator, handler);
    }
    if (schema.isSortable) {
        collectionCustomizer.replaceFieldSorting(name, [{ field: options.path, ascending: true }]);
    }
}
exports.default = importField;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0LWZpZWxkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3BsdWdpbnMvaW1wb3J0LWZpZWxkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsd0VBQTRFO0FBTzdELEtBQUssVUFBVSxXQUFXLENBSXZDLG9CQUE2QyxFQUM3QyxvQkFBZ0QsRUFDaEQsT0FBcUU7SUFFckUsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQXlCLENBQUM7SUFDL0MsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FDL0MsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDZCxNQUFNLFVBQVUsR0FBRyxvQkFBb0IsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQWdDLENBQUMsQ0FBQztRQUM3RixNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVwRCxJQUFJLFdBQVcsS0FBSyxTQUFTLEVBQUU7WUFDN0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLEtBQUssNEJBQTRCLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQzlFO1FBRUQsSUFBSSxXQUFXLENBQUMsSUFBSSxLQUFLLFFBQVE7WUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxDQUFDO1FBQ2xFLElBQUksV0FBVyxDQUFDLElBQUksS0FBSyxXQUFXLElBQUksV0FBVyxDQUFDLElBQUksS0FBSyxVQUFVO1lBQ3JFLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDdkQsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQzFDLENBQUMsRUFDRCxFQUFFLFVBQVUsRUFBRSxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsQ0FDMUMsQ0FBQztJQUVGLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUU7UUFDbEMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVO1FBQzdCLFlBQVksRUFBRSxNQUFNLENBQUMsWUFBWTtRQUNqQyxZQUFZLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO1FBQzVCLFNBQVMsRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxnQ0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xGLFVBQVUsRUFBRSxNQUFNLENBQUMsVUFBVTtLQUM5QixDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUU7UUFDM0Msb0JBQW9CLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFFO1lBQ3JELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3JDLE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQztZQUV2QixJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsVUFBVSxFQUFFLFdBQVcsRUFBRSxLQUFLLEVBQUUsRUFBRTtnQkFDN0MsVUFBVSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEtBQUssS0FBSyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7Z0JBRWpFLE9BQU8sVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ2pDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQztZQUVoQixPQUFPLFdBQVcsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztLQUNKO0lBRUQsSUFBSSxNQUFNLENBQUMsVUFBVSxJQUFJLE9BQU8sQ0FBQyxRQUFRLEtBQUssS0FBSyxFQUFFO1FBQ25ELE1BQU0sSUFBSSxLQUFLLENBQ2IsMERBQTBELE9BQU8sQ0FBQyxJQUFJLG1CQUFtQixDQUMxRixDQUFDO0tBQ0g7SUFFRCxLQUFLLE1BQU0sUUFBUSxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUU7UUFDN0MsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDcEUsb0JBQW9CLENBQUMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxPQUFtQyxDQUFDLENBQUM7S0FDaEc7SUFFRCxJQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUU7UUFDckIsb0JBQW9CLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0tBQzVGO0FBQ0gsQ0FBQztBQS9ERCw4QkErREMifQ==